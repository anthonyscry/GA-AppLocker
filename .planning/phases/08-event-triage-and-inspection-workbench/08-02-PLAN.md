---
phase: 08-event-triage-and-inspection-workbench
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - GA-AppLocker/GUI/MainWindow.xaml
  - GA-AppLocker/GUI/Panels/EventViewer.ps1
autonomous: true
requirements: [FLT-01, FLT-02, DET-01, DET-02]

must_haves:
  truths:
    - "Operator can select an event-code group from a ComboBox and the events grid immediately shows only matching rows"
    - "Operator can filter by action/outcome (All, Allowed, Blocked, Audit) and the events grid updates"
    - "Operator can type in host and user filter TextBoxes and see narrowed results"
    - "Operator can select an event row and see all normalized fields in the detail pane below the grid"
    - "Operator can view raw Message text and RawXml in read-only scrollable text areas in the detail pane"
    - "Detail pane collapses to hidden when no row is selected"
  artifacts:
    - path: "GA-AppLocker/GUI/MainWindow.xaml"
      provides: "Filter controls and detail pane XAML elements"
      contains: "CboEventViewerEventCodeFilter"
    - path: "GA-AppLocker/GUI/MainWindow.xaml"
      provides: "Detail pane section"
      contains: "PnlEventViewerDetail"
    - path: "GA-AppLocker/GUI/Panels/EventViewer.ps1"
      provides: "Filter reader helpers, detail pane update function, SelectionChanged wiring"
      contains: "Update-EventViewerDetailPane"
  key_links:
    - from: "GA-AppLocker/GUI/Panels/EventViewer.ps1 (SelectionChanged handler)"
      to: "GA-AppLocker/GUI/Panels/EventViewer.ps1 (Update-EventViewerDetailPane)"
      via: "EventViewerEventsDataGrid.Add_SelectionChanged calls Update-EventViewerDetailPane"
      pattern: "Add_SelectionChanged.*Update-EventViewerDetailPane"
    - from: "GA-AppLocker/GUI/Panels/EventViewer.ps1 (filter change handlers)"
      to: "GA-AppLocker/GUI/Panels/EventViewer.ps1 (Update-EventViewerResultBindings)"
      via: "Each filter control change triggers Update-EventViewerResultBindings which reads all filters"
      pattern: "Update-EventViewerResultBindings"
---

<objective>
Add filter controls, detail inspection pane, and all panel wiring so operators can triage events with structured filters and inspect selected events with full normalized data and raw XML.

Purpose: This is the user-facing deliverable of Phase 8 -- operators get ComboBox/TextBox filters for event code, action, host, and user, plus a detail pane that shows all normalized fields and raw event data for the selected row.
Output: XAML filter bar and detail pane, filter reader helper functions, Update-EventViewerDetailPane, SelectionChanged wiring, filter change handlers, behavioral tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-event-triage-and-inspection-workbench/08-RESEARCH.md
@.planning/phases/08-event-triage-and-inspection-workbench/08-01-SUMMARY.md
@GA-AppLocker/GUI/MainWindow.xaml
@GA-AppLocker/GUI/Panels/EventViewer.ps1
@Tests/Helpers/MockWpfHelpers.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter controls and detail pane XAML to Event Viewer panel</name>
  <files>GA-AppLocker/GUI/MainWindow.xaml</files>
  <action>
In MainWindow.xaml, locate the Event Viewer panel section (around line 3380-3615). Add two XAML sections:

**1. Filter Bar** -- Add a horizontal filter row between the existing search bar (`TxtEventViewerSearch`) and the events DataGrid (`EventViewerEventsDataGrid`). Use the same dark-theme styling as other panels. Include:

- `CboEventViewerEventCodeFilter` ComboBox with named groups as ComboBoxItems:
  - "All Events" (Tag="All", IsSelected="True")
  - "Blocked" (Tag="8002,8004,8006,8021,8024")
  - "Audit" (Tag="8003,8005,8007,8022,8025")
  - "Allowed" (Tag="8001,8020,8023")
  - "EXE/DLL" (Tag="8002,8003,8004,8005")
  - "Scripts" (Tag="8006,8007")
  - "MSI/Packaged" (Tag="8020,8021,8022,8023,8024,8025")
- `CboEventViewerActionFilter` ComboBox: "All", "Allowed", "Blocked", "Audit"
- `TxtEventViewerHostFilter` TextBox with placeholder-style prompt (use Watermark pattern or grey text)
- `TxtEventViewerUserFilter` TextBox with placeholder-style prompt

Style each control with dark theme colors (Background="#2D2D2D", Foreground="#E0E0E0", BorderBrush="#555555") and label each with a TextBlock. Use a horizontal StackPanel or WrapPanel for the filter row.

**2. Detail Pane** -- Add a collapsible detail section BELOW the events DataGrid. Use a Border with `x:Name="PnlEventViewerDetail"` and `Visibility="Collapsed"`. Inside:

- A Grid with two columns: labels (140px) and values (star).
- Label/value rows for: File Path, Event Type, Collection Type, User (SID), Host, Action, Enforcement Mode, Time.
- Named TextBlocks for each value: `TxtDetailFilePath`, `TxtDetailEventType`, `TxtDetailCollection`, `TxtDetailUser`, `TxtDetailHost`, `TxtDetailAction`, `TxtDetailEnforcement`, `TxtDetailTime`.
- Below the grid, two labeled read-only TextBox areas with ScrollViewer wrapping:
  - `TxtDetailMessage` (Height ~80, TextWrapping="Wrap", IsReadOnly="True", VerticalScrollBarVisibility="Auto")
  - `TxtDetailRawXml` (Height ~100, TextWrapping="Wrap", IsReadOnly="True", VerticalScrollBarVisibility="Auto", FontFamily="Consolas")
- Style with dark theme: Background="#1E1E1E", Foreground="#E0E0E0", border "#3C3C3C".

Ensure all `x:Name` values are unique and match exactly what the panel code will reference.
  </action>
  <verify>
Open MainWindow.xaml and verify: (1) no duplicate x:Name values, (2) filter controls appear between search and grid, (3) detail pane appears after the grid, (4) all named elements use consistent casing matching the panel code names.
  </verify>
  <done>XAML contains filter bar with CboEventViewerEventCodeFilter, CboEventViewerActionFilter, TxtEventViewerHostFilter, TxtEventViewerUserFilter. Detail pane with PnlEventViewerDetail border containing all labeled value TextBlocks plus Message and RawXml TextBoxes. No duplicate names.</done>
</task>

<task type="auto">
  <name>Task 2: Wire filter controls, detail pane update, and SelectionChanged in panel code</name>
  <files>
    GA-AppLocker/GUI/Panels/EventViewer.ps1
    Tests/Behavioral/GUI/EventViewer.Triage.Tests.ps1
  </files>
  <action>
In `EventViewer.ps1`, add the following functions and wiring:

**Filter reader helpers** (all `global:` scope per WPF scope rules):

1. `global:Get-EventViewerActiveEventIdFilter` -- reads `CboEventViewerEventCodeFilter.SelectedItem.Tag`, parses comma-separated IDs, returns `int[]`. Returns `@()` for "All" or missing control.
2. `global:Get-EventViewerActiveActionFilter` -- reads `CboEventViewerActionFilter.SelectedItem`, returns string ('', 'Allowed', 'Blocked', 'Audit'). Returns `''` for "All".
3. `global:Get-EventViewerActiveHostFilter` -- reads `TxtEventViewerHostFilter.Text`, returns trimmed string.
4. `global:Get-EventViewerActiveUserFilter` -- reads `TxtEventViewerUserFilter.Text`, returns trimmed string.

**Update-EventViewerResultBindings modification** -- modify the existing function to read all filter values before calling `Get-FilteredEventViewerRows`:
- Call each filter reader helper to get current values.
- Pass `EventIdFilter`, `ActionFilter`, `HostFilter`, `UserFilter` to `Get-FilteredEventViewerRows` alongside existing `SearchText`.
- Do NOT store filter state in module variables -- always read from controls (per research anti-pattern guidance).

**Detail pane function** (`global:Update-EventViewerDetailPane`):
- Parameters: `$Window`, `$Row`
- If `$Row` is null: set `PnlEventViewerDetail.Visibility = 'Collapsed'`, return.
- Otherwise: set `PnlEventViewerDetail.Visibility = 'Visible'`.
- Populate each named TextBlock/TextBox using safe property access pattern: check `$Row.PSObject.Properties.Name -contains 'FieldName'` before reading.
- Fields to populate: TxtDetailFilePath, TxtDetailEventType, TxtDetailCollection, TxtDetailUser, TxtDetailHost, TxtDetailAction, TxtDetailEnforcement, TxtDetailTime (formatted as 'yyyy-MM-dd HH:mm:ss'), TxtDetailMessage, TxtDetailRawXml.
- For missing RawXml on remote events, show "(not available for remote events)" if empty.

**Initialize-EventViewerPanel wiring** -- add to the existing initialization function:
- Wire `SelectionChanged` on `EventViewerEventsDataGrid` to call `Update-EventViewerDetailPane` with the selected item. Use `$global:GA_MainWindow` inside the handler (NOT `$script:`, per Lesson #2).
- Wire `SelectionChanged` on `CboEventViewerEventCodeFilter` and `CboEventViewerActionFilter` to trigger `Update-EventViewerResultBindings -Window $global:GA_MainWindow -EventRows $script:EventViewerResults`.
- Wire `Add_TextChanged` on `TxtEventViewerHostFilter` and `TxtEventViewerUserFilter` to trigger the same refresh call.
- Ensure detail pane starts collapsed (Visibility="Collapsed" in XAML handles this).

**Behavioral tests** -- create `Tests/Behavioral/GUI/EventViewer.Triage.Tests.ps1`:
- Use MockWpfHelpers pattern from existing EventViewer test files.
- Dot-source EventViewer.ps1 to get the global functions.
- Test FLT-01: Get-FilteredEventViewerRows with EventIdFilter narrows to matching IDs.
- Test FLT-01: Empty EventIdFilter returns all rows.
- Test FLT-02: ActionFilter narrows to matching action bucket.
- Test FLT-02: HostFilter substring match works.
- Test FLT-02: UserFilter substring match works.
- Test FLT-03: SearchText matches Message field.
- Test FLT-03: SearchText matches UserSid field.
- Test DET-01: Update-EventViewerDetailPane populates TextBlock values from row.
- Test DET-01: Update-EventViewerDetailPane collapses pane when row is null.
- Test DET-02: Update-EventViewerDetailPane shows RawXml content.
- Test DET-02: Update-EventViewerDetailPane shows "(not available for remote events)" for empty RawXml.
- Aim for 12-15 focused tests covering all 5 requirements.
  </action>
  <verify>
Run all EventViewer tests:
```powershell
Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Triage.Tests.ps1' -Output Detailed
Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Loading.Tests.ps1' -Output Minimal
Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Navigation.Tests.ps1' -Output Minimal
```
All tests must pass. Triage tests must cover FLT-01, FLT-02, FLT-03, DET-01, DET-02.
  </verify>
  <done>Filter reader helpers read from window controls. Update-EventViewerResultBindings passes filter values to Get-FilteredEventViewerRows. Update-EventViewerDetailPane populates all detail fields from selected row. SelectionChanged wired. Filter control changes trigger result refresh. Behavioral tests pass for all 5 requirements.</done>
</task>

</tasks>

<verification>
1. `Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Triage.Tests.ps1' -Output Detailed` -- all tests pass, covering FLT-01/02/03/DET-01/DET-02.
2. `Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Loading.Tests.ps1' -Output Minimal` -- zero regressions.
3. `Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Navigation.Tests.ps1' -Output Minimal` -- zero regressions.
4. XAML has no duplicate x:Name values for new controls.
5. Detail pane is Collapsed by default and becomes Visible on row selection.
6. Filter changes immediately narrow the events grid without re-querying backend.
</verification>

<success_criteria>
- Event-code ComboBox filter narrows grid results to matching event IDs.
- Action/host/user filters each independently reduce visible rows.
- Search bar matches against Message and UserSid in addition to original fields.
- Selecting a row populates the detail pane with all normalized fields.
- Raw XML and Message text are visible in scrollable read-only areas.
- Detail pane collapses when no row is selected.
- All existing and new EventViewer tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/08-event-triage-and-inspection-workbench/08-02-SUMMARY.md`
</output>
