---
phase: 08-event-triage-and-inspection-workbench
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1
  - GA-AppLocker/GUI/Panels/EventViewer.ps1
autonomous: true
requirements: [FLT-01, FLT-02, FLT-03]

must_haves:
  truths:
    - "Get-FilteredEventViewerRows accepts optional EventIdFilter, ActionFilter, HostFilter, UserFilter parameters and returns only matching rows"
    - "Search text haystack covers Message and UserSid fields in addition to existing fields"
    - "ConvertTo-EventViewerRows carries all inspection fields (UserSid, EventType, EnforcementMode, IsBlocked, IsAudit, Message, RawXml) through to row objects"
    - "ConvertTo-AppLockerEventRecord captures RawXml via ToXml() for live EventLogRecord objects"
    - "Existing callers of Get-FilteredEventViewerRows and ConvertTo-EventViewerRows continue to work without modification"
  artifacts:
    - path: "GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1"
      provides: "RawXml field on normalized event record"
      contains: "RawXml"
    - path: "GA-AppLocker/GUI/Panels/EventViewer.ps1"
      provides: "Extended filter function and enriched row projection"
      contains: "EventIdFilter"
  key_links:
    - from: "GA-AppLocker/GUI/Panels/EventViewer.ps1 (ConvertTo-EventViewerRows)"
      to: "GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1 (ConvertTo-AppLockerEventRecord)"
      via: "RawXml field propagated from record through envelope to row"
      pattern: "RawXml.*event\\.RawXml"
---

<objective>
Enrich the event data pipeline to carry all inspection fields through to UI rows, extend the filter function to accept dimension filter parameters, and broaden the search haystack to cover forensic text fields.

Purpose: Phase 8's filter controls and detail pane require enriched row data and a parameterized filter function. This plan prepares the data model so Plan 02 can wire UI controls without changing function signatures.
Output: Extended `Get-FilteredEventViewerRows` with dimension filtering, enriched `ConvertTo-EventViewerRows` with all inspection fields, `RawXml` capture in `ConvertTo-AppLockerEventRecord`.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-event-triage-and-inspection-workbench/08-RESEARCH.md
@.planning/phases/07-event-ingestion-and-bounded-retrieval/07-03-SUMMARY.md
@GA-AppLocker/GUI/Panels/EventViewer.ps1
@GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ConvertTo-AppLockerEventRecord with RawXml capture and enrich ConvertTo-EventViewerRows</name>
  <files>
    GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1
    GA-AppLocker/GUI/Panels/EventViewer.ps1
  </files>
  <action>
In `Get-AppLockerEventLogs.ps1`, extend `ConvertTo-AppLockerEventRecord` to add a `RawXml` field:
- After the existing field assignments, add a try/catch block that checks `if ($Event -is [System.Diagnostics.Eventing.Reader.EventLogRecord])` and calls `$Event.ToXml()`.
- For non-live objects (deserialized from remote), set RawXml to empty string.
- The field must appear in the returned PSCustomObject alongside existing fields.

In `EventViewer.ps1`, extend `ConvertTo-EventViewerRows` (currently at line ~961) to carry all inspection fields from the envelope event data through to the row PSCustomObject:
- Add: `UserSid`, `EventType`, `EnforcementMode`, `IsBlocked`, `IsAudit`, `Message`, `RawXml`
- Use the same safe property-access pattern already used for existing fields: `if ($event.PSObject.Properties.Name -contains 'FieldName') { [string]$event.FieldName } else { '' }`
- For boolean fields (`IsBlocked`, `IsAudit`), use `[bool]` cast with `$false` default.
- Do NOT add new DataGrid columns for Message or RawXml (they are for the detail pane only, per research anti-pattern guidance).
- Ensure the existing 6 fields remain unchanged in position and behavior.
  </action>
  <verify>
Import the module and confirm ConvertTo-AppLockerEventRecord output includes RawXml field. Verify ConvertTo-EventViewerRows output objects have all 13 properties (6 original + 7 new). Run existing tests: `Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Loading.Tests.ps1' -Output Minimal` -- all must pass (new fields are additive, no signature breaks).
  </verify>
  <done>ConvertTo-AppLockerEventRecord returns objects with RawXml field. ConvertTo-EventViewerRows returns objects with all 13 inspection fields. Existing loading tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Extend Get-FilteredEventViewerRows with dimension filters and broadened search haystack</name>
  <files>GA-AppLocker/GUI/Panels/EventViewer.ps1</files>
  <action>
Extend `Get-FilteredEventViewerRows` (currently at line ~348) to accept optional dimension filter parameters. All new parameters MUST have defaults that produce no-filter behavior so existing callers continue to work:

Add parameters:
- `[int[]]$EventIdFilter = @()` -- when non-empty, keep only rows where EventId is in the set (use HashSet for O(1) lookup)
- `[string]$ActionFilter = ''` -- when non-empty, keep only rows where the action bucket (via `Get-EventViewerActionBucket`) matches (case-insensitive)
- `[string]$HostFilter = ''` -- when non-empty, keep only rows where ComputerName contains the substring (case-insensitive)
- `[string]$UserFilter = ''` -- when non-empty, keep only rows where UserSid contains the substring (case-insensitive)

Apply dimension filters BEFORE search text, in this order: EventIdFilter, ActionFilter, HostFilter, UserFilter, then SearchText.

For the search text haystack (FLT-03), extend the existing haystack array to also include:
- `Message` field (if present on row)
- `UserSid` field (if present on row)

These are in addition to the existing 5 fields (FilePath, ComputerName, EventId, CollectionType, Action).

Follow the research code example closely (Pattern 1 in 08-RESEARCH.md). Use `[System.Collections.Generic.HashSet[int]]` for EventIdFilter matching. Use `foreach` with `[void]$list.Add()` for filtered results (PS 5.1 safe).

Do NOT add time-range sub-filter parameters yet -- the existing bounded query already constrains the time window at retrieval time. Time filtering within loaded results can be added later if needed.
  </action>
  <verify>
Test manually in PowerShell:
```powershell
$rows = @(
  [PSCustomObject]@{ EventId = 8003; FilePath = 'C:\A.exe'; ComputerName = 'H1'; CollectionType = 'Exe'; Action = 'Audit'; Message = 'test msg'; UserSid = 'S-1-5-21-1001' },
  [PSCustomObject]@{ EventId = 8004; FilePath = 'C:\B.exe'; ComputerName = 'H2'; CollectionType = 'Exe'; Action = 'Blocked'; Message = 'blocked'; UserSid = 'S-1-5-21-1002' }
)
# No filters = all rows
(Get-FilteredEventViewerRows -Rows $rows).Count -eq 2
# EventId filter
(Get-FilteredEventViewerRows -Rows $rows -EventIdFilter @(8003)).Count -eq 1
# Search text hits Message field
(Get-FilteredEventViewerRows -Rows $rows -SearchText 'blocked').Count -eq 1
```
Run existing tests: `Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Loading.Tests.ps1' -Output Minimal` -- all must pass.
  </verify>
  <done>Get-FilteredEventViewerRows accepts EventIdFilter, ActionFilter, HostFilter, UserFilter parameters with no-op defaults. Search haystack includes Message and UserSid. Existing callers (Update-EventViewerResultBindings, loading tests) work without modification.</done>
</task>

</tasks>

<verification>
1. `Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Loading.Tests.ps1' -Output Minimal` -- zero failures (backward compatibility).
2. `Invoke-Pester -Path 'Tests/Behavioral/GUI/EventViewer.Navigation.Tests.ps1' -Output Minimal` -- zero failures.
3. ConvertTo-EventViewerRows output includes UserSid, EventType, EnforcementMode, IsBlocked, IsAudit, Message, RawXml fields.
4. Get-FilteredEventViewerRows with no new params returns same results as before.
5. Get-FilteredEventViewerRows with EventIdFilter narrows to matching IDs only.
</verification>

<success_criteria>
- All existing EventViewer behavioral tests pass without modification.
- Row objects carry 13 fields (6 original + 7 inspection).
- Filter function accepts 4 new optional parameters with backward-compatible defaults.
- Search text matches against Message and UserSid fields.
</success_criteria>

<output>
After completion, create `.planning/phases/08-event-triage-and-inspection-workbench/08-01-SUMMARY.md`
</output>
