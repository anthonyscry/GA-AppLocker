---
phase: 12-module-test-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Tests/Unit/Deployment.Tests.ps1
autonomous: true
requirements:
  - TEST-02

must_haves:
  truths:
    - "Creating a deployment job returns Success with a job object containing JobId, PolicyId, GPOName, Status=Pending"
    - "Retrieving a job by ID returns the correct job data from disk"
    - "Updating a Pending job changes GPOName/Schedule and persists; updating a non-Pending job returns an error"
    - "Stop-Deployment cancels a Pending/Running job but rejects already-completed/failed/cancelled jobs"
    - "Get-AllDeploymentJobs returns all jobs sorted by CreatedAt descending, with optional status filter"
    - "Remove-DeploymentJob deletes by JobId or by Status filter and returns removed count"
    - "Start-Deployment with missing GroupPolicy module returns ManualRequired with XML export path"
  artifacts:
    - path: "Tests/Unit/Deployment.Tests.ps1"
      provides: "Unit tests for GA-AppLocker.Deployment module"
      contains: "Describe"
  key_links:
    - from: "Tests/Unit/Deployment.Tests.ps1"
      to: "GA-AppLocker/Modules/GA-AppLocker.Deployment/Functions/*.ps1"
      via: "Import-Module and function calls"
      pattern: "New-DeploymentJob|Get-DeploymentJob|Update-DeploymentJob|Start-Deployment|Stop-Deployment|Remove-DeploymentJob"
---

<objective>
Create unit tests for the GA-AppLocker.Deployment module covering job CRUD, status transitions, GPO import paths (including the ManualRequired fallback), and deployment history.

Purpose: The Deployment module manages the full deploy lifecycle (create job, start, track progress, cancel) with fallback paths for missing GroupPolicy/AppLocker modules -- critical for air-gapped environments. Tests verify these contracts work correctly.

Output: Tests/Unit/Deployment.Tests.ps1 with passing Pester tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@GA-AppLocker/Modules/GA-AppLocker.Deployment/GA-AppLocker.Deployment.psm1
@GA-AppLocker/Modules/GA-AppLocker.Deployment/Functions/New-DeploymentJob.ps1
@GA-AppLocker/Modules/GA-AppLocker.Deployment/Functions/Start-Deployment.ps1
@GA-AppLocker/Modules/GA-AppLocker.Deployment/Functions/Update-DeploymentJob.ps1
@GA-AppLocker/Modules/GA-AppLocker.Deployment/Functions/GPO-Functions.ps1
@Tests/Behavioral/Core/Policy.Behavior.Tests.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Deployment module unit tests</name>
  <files>Tests/Unit/Deployment.Tests.ps1</files>
  <action>
Create `Tests/Unit/Deployment.Tests.ps1` following the project's existing Pester test conventions.

The Deployment module depends on:
- `Get-AppLockerDataPath` (Core module) -- mock to return temp directory
- `Get-Policy` (Policy module) -- mock to return a valid policy result for New-DeploymentJob
- `Export-PolicyToXml` (Policy module) -- mock for Start-Deployment tests
- `Set-PolicyStatus` (Policy module) -- mock for Start-Deployment completion
- GroupPolicy cmdlets (Get-GPO, New-GPO, Set-AppLockerPolicy) -- mock all; these require domain controllers

**Test setup pattern:**
1. Import module via root `GA-AppLocker.psd1`
2. Mock `Get-AppLockerDataPath` to return a unique temp directory
3. Mock `Get-Policy` to return `@{ Success = $true; Data = @{ PolicyId = 'test-policy'; Name = 'Test Policy' } }`
4. Create BOTH the `Deployments` AND `DeploymentHistory` subdirectories inside the temp path (Start-Deployment calls the private `Add-DeploymentHistory` function which writes to `DeploymentHistory/`; without this directory, tests will fail or leak files)
5. Alternatively, use `InModuleScope 'GA-AppLocker.Deployment'` to mock `Add-DeploymentHistory` with `{}` for Start-Deployment tests, preventing disk writes entirely
6. Clean up temp directory in AfterAll

Test coverage areas (aim for 20-30 tests):

**New-DeploymentJob:**
- Creates a job and returns `@{ Success = $true; Data = <job> }`
- Job data has required fields: JobId (GUID), PolicyId, PolicyName, GPOName, Status='Pending', Progress=0, CreatedAt, CreatedBy
- Schedule defaults to 'Manual'
- TargetOUs stored as array
- Job JSON file written to Deployments directory
- Missing policy returns `@{ Success = $false; Error = "Policy not found..." }` (mock Get-Policy to return failure)

**Get-DeploymentJob:**
- Retrieves existing job by JobId
- Non-existent JobId returns `@{ Success = $false; Error = "...not found..." }`

**Get-AllDeploymentJobs:**
- Returns all jobs sorted by CreatedAt descending
- `-Status 'Pending'` filters to only Pending jobs
- Empty directory returns `@{ Success = $true; Data = @() }`

**Update-DeploymentJob:**
- Updates GPOName on a Pending job
- Updates Schedule on a Pending job
- Updates TargetOUs on a Pending job
- Rejects update on non-Pending job (change status to 'Running' by writing directly to file, then try update)
- No changes returns success with "no changes" message
- **IMPORTANT:** `Update-DeploymentJob` has a Version-based concurrency check. `New-DeploymentJob` does NOT set a `Version` field, so $job.Version is $null. The update function reads the file, checks `$null -ne ($null + 1)` which is always $true, causing a "Concurrent modification detected" error on every call. To work around this: before calling `Update-DeploymentJob`, read the job JSON file, add a `"Version": 0` property, and write it back. Alternatively, test and document this as known broken behavior (test that Update-DeploymentJob returns a concurrency error on unversioned jobs, and test that it succeeds on pre-versioned jobs).

**Stop-Deployment:**
- Cancels a Pending job (sets Status='Cancelled', CompletedAt populated)
- Cancels a Running job
- Rejects cancelling Completed/Failed/Cancelled jobs
- Non-existent job returns error

**Remove-DeploymentJob:**
- Removes by JobId, returns Data=1
- Removes by Status (create 2 Completed + 1 Pending, remove by Status='Completed', returns Data=2)
- Neither JobId nor Status returns error

**Start-Deployment (GPO import paths):**
- Mock `Test-GPOExists` to return `@{ Success = $false; ManualRequired = $true; Error = "GroupPolicy module not available" }` -- verify job status becomes 'ManualRequired' and result includes ManualRequired=$true
- Mock `Export-PolicyToXml` to return failure -- verify job status becomes 'Failed'
- Mock all GPO functions successfully + mock `Import-PolicyToGPO` to return success -- verify job status becomes 'Completed' with Progress=100

**Get-DeploymentHistory:**
- Returns empty array when no history exists
- (History entries are created by Start-Deployment internals -- tested implicitly via Start-Deployment success path)

**Important implementation notes:**
- Mock `Write-AppLockerLog` with `{}` to suppress log calls from functions that call it directly (Start-Deployment, GPO-Functions)
- For Start-Deployment tests, you need to mock multiple functions: Export-PolicyToXml, Test-GPOExists, New-AppLockerGPO, Import-PolicyToGPO, Set-PolicyStatus
- Use `InModuleScope` if needed for mocking module-internal functions, OR mock at the command level since these are all exported functions
- Write deployment job files directly for tests that need specific Status values (e.g., testing Stop-Deployment on a Running job)
  </action>
  <verify>
Run: `Invoke-Pester -Path Tests/Unit/Deployment.Tests.ps1 -Output Detailed`
All tests pass with zero failures.
  </verify>
  <done>
Deployment.Tests.ps1 exists in Tests/Unit/, all tests pass, covering job creation, retrieval, status filtering, update constraints (Pending-only), cancellation logic, removal by id/status, and the GPO import paths including ManualRequired fallback.
  </done>
</task>

</tasks>

<verification>
```powershell
# All Deployment tests pass
Invoke-Pester -Path Tests/Unit/Deployment.Tests.ps1 -Output Detailed
```
</verification>

<success_criteria>
- Tests/Unit/Deployment.Tests.ps1 exists and has 20+ test cases
- All tests pass when run via Invoke-Pester
- Tests cover: job CRUD (create, get, get-all, update, remove), status transitions (Pending->Running->Completed, Pending->Cancelled, rejection of invalid transitions), GPO import paths (success, ManualRequired fallback, export failure), and deployment history
</success_criteria>

<output>
After completion, create `.planning/phases/12-module-test-coverage/12-02-SUMMARY.md`
</output>
