---
phase: 12-module-test-coverage
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Tests/Unit/Setup.Tests.ps1
autonomous: true
requirements:
  - TEST-03

must_haves:
  truths:
    - "Get-SetupStatus returns a structured status object with ModulesAvailable, WinRM, AppLockerGPOs, and ADStructure sections"
    - "Initialize-WinRMGPO creates a GPO with 5 registry value writes (service auto-start, AllowAutoConfig, IPv4Filter, IPv6Filter, firewall rule)"
    - "Initialize-AppLockerGPOs creates 3 GPOs (DC, Servers, Workstations) linked to appropriate OUs"
    - "Initialize-AppLockerEnvironment orchestrates all sub-initializers and returns aggregate success"
    - "Enable/Disable WinRMGPO toggle the GPO settings status between AllSettingsEnabled and AllSettingsDisabled"
    - "Missing GroupPolicy module causes functions to throw or return appropriate errors"
  artifacts:
    - path: "Tests/Unit/Setup.Tests.ps1"
      provides: "Unit tests for GA-AppLocker.Setup module"
      contains: "Describe"
  key_links:
    - from: "Tests/Unit/Setup.Tests.ps1"
      to: "GA-AppLocker/Modules/GA-AppLocker.Setup/Functions/*.ps1"
      via: "Import-Module and function calls"
      pattern: "Initialize-WinRMGPO|Initialize-AppLockerGPOs|Initialize-ADStructure|Get-SetupStatus|Initialize-AppLockerEnvironment"
---

<objective>
Create unit tests for the GA-AppLocker.Setup module covering environment initialization, WinRM GPO configuration, AppLocker GPO creation, and setup status reporting.

Purpose: The Setup module orchestrates domain-wide configuration (GPOs, OUs, security groups) for AppLocker deployment. Every function requires AD/GPO modules that are unavailable in test environments, so all external calls must be mocked. Tests verify the orchestration logic, error paths, and return object structure.

Output: Tests/Unit/Setup.Tests.ps1 with passing Pester tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@GA-AppLocker/Modules/GA-AppLocker.Setup/GA-AppLocker.Setup.psm1
@GA-AppLocker/Modules/GA-AppLocker.Setup/Functions/Initialize-WinRMGPO.ps1
@GA-AppLocker/Modules/GA-AppLocker.Setup/Functions/Initialize-AppLockerGPOs.ps1
@GA-AppLocker/Modules/GA-AppLocker.Setup/Functions/Initialize-ADStructure.ps1
@GA-AppLocker/Modules/GA-AppLocker.Setup/Functions/Get-SetupStatus.ps1
@Tests/Behavioral/Core/Policy.Behavior.Tests.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Setup module unit tests</name>
  <files>Tests/Unit/Setup.Tests.ps1</files>
  <action>
Create `Tests/Unit/Setup.Tests.ps1` following the project's existing Pester test conventions.

The Setup module is **entirely dependent on domain infrastructure** (GroupPolicy module, ActiveDirectory module, Get-GPO, New-GPO, Get-ADDomain, etc.). Every test must mock these external calls. The key insight: we are testing the ORCHESTRATION LOGIC, not the AD/GPO operations themselves.

**Mocking strategy:**
1. Import module via root `GA-AppLocker.psd1`
2. Mock `Get-Module` (for `-ListAvailable` checks) to control which modules appear available
3. Mock all GroupPolicy cmdlets: `Get-GPO`, `New-GPO`, `Remove-GPO`, `Set-GPRegistryValue`, `New-GPLink`, `Set-GPLink`, `Get-GPInheritance`, `Get-GPOReport`, `Import-Module` (selectively for GroupPolicy/ActiveDirectory)
4. Mock all ActiveDirectory cmdlets: `Get-ADDomain`, `Get-ADOrganizationalUnit`, `Get-ADGroup`, `New-ADOrganizationalUnit`, `New-ADGroup`, `Get-ADObject`
5. Mock `Write-AppLockerLog` with `{}` to suppress log output

**CRITICAL: Module-scoped variables.** The Setup module uses `$script:DefaultGPONames`, `$script:DefaultGroups`, etc. These are set during module load. The tests must work with these values via the exported functions, not by accessing `$script:` directly.

Test coverage areas (aim for 15-25 tests):

**Get-SetupStatus (return structure):**
- When GroupPolicy module is available, returns status with WinRM, DisableWinRM, and AppLockerGPOs sections
- When GroupPolicy module is NOT available, WinRM.Status = 'Module Not Available'
- When WinRM GPO exists, status includes Exists=$true with GPOName, GPOId
- When WinRM GPO does not exist, status includes Exists=$false, Status='Not Created'
- AppLockerGPOs array contains 3 entries (DC, Servers, Workstations) with Type, Name, Exists, Status fields
- When ActiveDirectory module is NOT available, ADStructure.Status = 'Module Not Available'
- Return object has Success=$true and Data is the status object

**Initialize-WinRMGPO:**
- When GroupPolicy module is unavailable, throws/returns error about RSAT
- When GPO already exists, reuses existing GPO (mock Get-GPO to return an object)
- When GPO does not exist, calls New-GPO to create it
- Sets 5 registry values via Set-GPRegistryValue (verify with `-ParameterFilter` or call count of 5): WinRM service auto-start, AllowAutoConfig, IPv4Filter, IPv6Filter, firewall rule
- Returns Success=$true with Data containing GPOName, SettingsApplied array
- SettingsApplied array has 5 entries (service, AllowAutoConfig, IPv4Filter, IPv6Filter, firewall)

**Initialize-AppLockerGPOs:**
- Creates 3 GPOs (AppLocker-DC, AppLocker-Servers, AppLocker-Workstations)
- Returns Success=$true with Data array of 3 entries
- When `-CreateOnly` is specified, does not call New-GPLink
- When GPOs already exist, reuses them (Status = 'Existing')
- When GroupPolicy module is unavailable, returns error

**Initialize-ADStructure:**
- When ActiveDirectory module is unavailable, returns error
- When OU already exists, does not create a new one
- Creates 6 security groups (AppLocker-Admins, -Exempt, -Audit, -Users, -Installers, -Developers)
- Returns Success=$true with Data containing OUName, Groups array

**Initialize-AppLockerEnvironment:**
- Calls Initialize-WinRMGPO, Initialize-DisableWinRMGPO, Initialize-AppLockerGPOs, Initialize-ADStructure
- Returns Success=$true when at least one sub-initializer succeeds (OR logic)
- Returns Data hashtable with WinRM, DisableWinRM, AppLockerGPOs, ADStructure keys

**Enable-WinRMGPO / Disable-WinRMGPO:**
- Enable returns Success=$true when GPO exists
- Disable returns Success=$true when GPO exists
- Both return error when GPO not found
- Both return error when GroupPolicy module unavailable
- **CRITICAL: GpoStatus enum type.** These functions assign `[Microsoft.GroupPolicy.GpoStatus]::AllSettingsEnabled` / `AllSettingsDisabled` to `$gpo.GpoStatus`. On machines without RSAT, this type does not exist and will throw "Unable to find type". To handle this in tests: EITHER (a) define a stub enum before tests via `Add-Type -TypeDefinition 'namespace Microsoft.GroupPolicy { public enum GpoStatus { AllSettingsEnabled = 0, AllSettingsDisabled = 3 } }'` (wrap in try/catch to skip if type already loaded), OR (b) scope Enable/Disable tests to only verify that `Get-GPO` was called and `Success` is returned, without asserting on the GpoStatus property value, OR (c) use `InModuleScope` to mock the internal assignment. Option (a) is recommended as it most closely simulates the real environment.

**Important implementation notes:**
- The module's `Test-ModuleAvailable` is a `script:` function. Since it wraps `Get-Module -ListAvailable`, mock `Get-Module` instead.
- `Get-DomainDN` is also `script:` scope. Mock `Get-ADDomain` to return `@{ DistinguishedName = 'DC=test,DC=local' }` so it resolves correctly. Also set `$env:USERDNSDOMAIN = 'test.local'` as fallback.
- Mock `Get-GPO` to return objects with `.Id`, `.DisplayName`, `.GpoStatus` properties using `[PSCustomObject]`
- For GpoStatus mocking on Get-GPO return values, use a string property since `[Microsoft.GroupPolicy.GpoStatus]` type won't exist without the real module. The code calls `.GpoStatus.ToString()` which works on strings too.
- **CRITICAL:** For Enable-WinRMGPO / Disable-WinRMGPO tests, the functions ASSIGN to `$gpo.GpoStatus` using the `[Microsoft.GroupPolicy.GpoStatus]` enum type directly. You MUST define a stub enum via `Add-Type` in BeforeAll: `try { Add-Type -TypeDefinition 'namespace Microsoft.GroupPolicy { public enum GpoStatus { AllSettingsEnabled = 0, AllSettingsDisabled = 3 } }' } catch {}` (the catch handles the case where the type is already loaded from a previous test run or from the real RSAT module).
- Use `InModuleScope 'GA-AppLocker.Setup'` if needed to access module-scoped helper functions or variables for testing.
  </action>
  <verify>
Run: `Invoke-Pester -Path Tests/Unit/Setup.Tests.ps1 -Output Detailed`
All tests pass with zero failures.
  </verify>
  <done>
Setup.Tests.ps1 exists in Tests/Unit/, all tests pass, covering Get-SetupStatus return structure with/without modules, Initialize-WinRMGPO creation and registry settings, Initialize-AppLockerGPOs 3-GPO creation and CreateOnly mode, Initialize-ADStructure OU/groups creation, Initialize-AppLockerEnvironment orchestration, and Enable/Disable WinRMGPO toggling.
  </done>
</task>

</tasks>

<verification>
```powershell
# All Setup tests pass
Invoke-Pester -Path Tests/Unit/Setup.Tests.ps1 -Output Detailed
```
</verification>

<success_criteria>
- Tests/Unit/Setup.Tests.ps1 exists and has 15+ test cases
- All tests pass when run via Invoke-Pester
- Tests cover: Get-SetupStatus structure (with/without modules), Initialize-WinRMGPO (create, reuse, registry settings, missing module error), Initialize-AppLockerGPOs (3 GPOs, CreateOnly, reuse existing), Initialize-ADStructure (OU + 6 groups, missing module), Initialize-AppLockerEnvironment (orchestration, OR success logic), Enable/Disable toggle
</success_criteria>

<output>
After completion, create `.planning/phases/12-module-test-coverage/12-03-SUMMARY.md`
</output>
