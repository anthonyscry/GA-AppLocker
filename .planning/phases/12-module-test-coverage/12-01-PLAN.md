---
phase: 12-module-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Tests/Unit/Credentials.Tests.ps1
autonomous: true
requirements:
  - TEST-01

must_haves:
  truths:
    - "Credential creation returns Success with profile data containing Id, Name, Username, Tier, and TierName"
    - "Credential retrieval by Name, Id, and Tier all return correct filtered results"
    - "Tier-based fallback returns the default credential for a tier, or first available when no default exists"
    - "Removing a credential profile deletes the JSON file and returns Success"
    - "Creating a duplicate-named credential returns an error without creating a second file"
  artifacts:
    - path: "Tests/Unit/Credentials.Tests.ps1"
      provides: "Unit tests for GA-AppLocker.Credentials module"
      contains: "Describe"
  key_links:
    - from: "Tests/Unit/Credentials.Tests.ps1"
      to: "GA-AppLocker/Modules/GA-AppLocker.Credentials/Functions/*.ps1"
      via: "Import-Module and function calls"
      pattern: "New-CredentialProfile|Get-CredentialProfile|Get-CredentialForTier|Remove-CredentialProfile"
---

<objective>
Create unit tests for the GA-AppLocker.Credentials module covering credential creation, retrieval by multiple keys, tier-based fallback, and removal.

Purpose: The Credentials module handles DPAPI-encrypted credential storage with tiered access (T0/T1/T2) but has zero test coverage. Tests verify the core CRUD contracts and the tier-based fallback chain that scanning depends on.

Output: Tests/Unit/Credentials.Tests.ps1 with passing Pester tests.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@GA-AppLocker/Modules/GA-AppLocker.Credentials/GA-AppLocker.Credentials.psm1
@GA-AppLocker/Modules/GA-AppLocker.Credentials/Functions/New-CredentialProfile.ps1
@GA-AppLocker/Modules/GA-AppLocker.Credentials/Functions/Get-CredentialProfile.ps1
@GA-AppLocker/Modules/GA-AppLocker.Credentials/Functions/Remove-CredentialProfile.ps1
@GA-AppLocker/Modules/GA-AppLocker.Credentials/Functions/Test-CredentialProfile.ps1
@Tests/Behavioral/Core/Policy.Behavior.Tests.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Credentials module unit tests</name>
  <files>Tests/Unit/Credentials.Tests.ps1</files>
  <action>
Create `Tests/Unit/Credentials.Tests.ps1` following the project's existing Pester test conventions (see Policy.Behavior.Tests.ps1 for patterns). The test file must:

1. Import the module via `Import-Module` from the relative path to `GA-AppLocker.psd1` (the root manifest).
2. Use a dedicated temp directory for credential storage by mocking `Get-AppLockerDataPath` to return a unique temp path per test run. **CRITICAL:** Use `-ModuleName 'GA-AppLocker.Credentials'` on the mock so it intercepts calls from inside the Credentials module (the module calls Get-AppLockerDataPath via its private Get-CredentialStoragePath helper â€” without `-ModuleName`, the mock won't intercept). Clean up in `AfterAll`/`AfterEach`.
3. Create real `[PSCredential]` objects using `[System.Management.Automation.PSCredential]::new('TestUser', (ConvertTo-SecureString 'TestPass123!' -AsPlainText -Force))`.

Test coverage areas (aim for 15-25 tests):

**New-CredentialProfile:**
- Creates a profile and returns `@{ Success = $true; Data = <profile> }`
- Data contains required fields: Id (GUID format), Name, Username, Tier, TierName, Description, IsDefault, CreatedDate
- Tier 0 maps to TierName 'DomainController', Tier 1 to 'Server', Tier 2 to 'Workstation'
- `-SetAsDefault` flag sets IsDefault = $true
- Duplicate name returns `@{ Success = $false; Error = "...already exists" }`
- Profile JSON file is created on disk

**Get-CredentialProfile:**
- Retrieve by `-Name` returns matching profile
- Retrieve by `-Id` returns matching profile
- Retrieve by `-Tier` returns all profiles for that tier
- No parameters returns all profiles
- Non-existent name returns Success=$true with Data=$null

**Get-CredentialForTier:**
- Returns a `[PSCredential]` object for the given tier
- Prefers the default profile for the tier
- Falls back to first available when no default exists
- Returns error when no profiles exist for the tier
- `-ProfileName` overrides tier-based lookup
- Updates LastUsed on the profile after retrieval

**Remove-CredentialProfile:**
- Removes by `-Name` and returns Success=$true
- Removes by `-Id` and returns Success=$true
- Non-existent profile returns error
- JSON file is deleted from disk after removal

**Important implementation notes:**
- Use unique names per test to avoid collisions: `"TestCred_$([guid]::NewGuid().ToString('N').Substring(0,8))"`
- Mock `Get-AppLockerDataPath` to return a unique temp path to isolate from real data
- Do NOT mock `Write-AppLockerLog` -- it already handles missing commands gracefully via `Write-CredLog`
- The module uses DPAPI encryption (`ConvertFrom-SecureString`/`ConvertTo-SecureString`) which only works on the same machine/user -- this is fine for unit tests running locally
- Test-CredentialProfile requires network connectivity (WinRM) so SKIP those tests or just verify the function exists (do not call it)
  </action>
  <verify>
Run: `Invoke-Pester -Path Tests/Unit/Credentials.Tests.ps1 -Output Detailed`
All tests pass with zero failures.
  </verify>
  <done>
Credentials.Tests.ps1 exists in Tests/Unit/, all tests pass, covering credential creation with all 3 tiers, retrieval by name/id/tier, tier-based fallback (default vs first-available), duplicate detection, and removal.
  </done>
</task>

</tasks>

<verification>
```powershell
# All Credentials tests pass
Invoke-Pester -Path Tests/Unit/Credentials.Tests.ps1 -Output Detailed
```
</verification>

<success_criteria>
- Tests/Unit/Credentials.Tests.ps1 exists and has 15+ test cases
- All tests pass when run via Invoke-Pester
- Tests cover: creation (3 tiers + defaults + duplicates), retrieval (by name, id, tier, all), tier fallback (default preference, first-available fallback, missing tier error), removal (by name, by id, not found)
</success_criteria>

<output>
After completion, create `.planning/phases/12-module-test-coverage/12-01-SUMMARY.md`
</output>
