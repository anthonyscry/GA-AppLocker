---
phase: 10-error-handling-hardening
plan: 04
type: execute
wave: 2
depends_on:
  - "10-01"
  - "10-02"
  - "10-03"
files_modified:
  - GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Invoke-BatchRuleGeneration.ps1
  - GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1
  - GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Remove-DuplicateRules.ps1
  - GA-AppLocker/GUI/Panels/Scanner.ps1
  - GA-AppLocker/GUI/Panels/Rules.ps1
  - GA-AppLocker/GUI/Panels/Policy.ps1
  - GA-AppLocker/GUI/Panels/Deploy.ps1
  - GA-AppLocker/GUI/Panels/Dashboard.ps1
  - GA-AppLocker/GUI/Panels/Credentials.ps1
autonomous: true
requirements:
  - ERR-04
  - ERR-05

must_haves:
  truths:
    - "Invoke-BatchRuleGeneration returns @{ Success; Data; Error } on both success and failure paths instead of returning $null"
    - "Get-AppLockerEventLogs returns @{ Success; Data; Error } on both success and failure paths instead of returning $null"
    - "Remove-DuplicateRules returns @{ Success; Data; Error } on both success and failure paths instead of returning $null"
    - "Scan failures in Scanner panel produce a toast notification visible to the operator"
    - "Rule save/import failures in Rules panel produce a toast notification"
    - "Policy export and creation failures in Policy panel produce a toast notification"
    - "Deployment failures in Deploy panel produce a toast notification"
  artifacts:
    - path: "GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Invoke-BatchRuleGeneration.ps1"
      provides: "Standardized return pattern replacing raw $null returns"
    - path: "GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1"
      provides: "Standardized return pattern replacing raw $null returns"
    - path: "GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Remove-DuplicateRules.ps1"
      provides: "Standardized return pattern replacing raw $null returns"
    - path: "GA-AppLocker/GUI/Panels/Scanner.ps1"
      provides: "Toast notifications for scan failures"
    - path: "GA-AppLocker/GUI/Panels/Rules.ps1"
      provides: "Toast notifications for rule save/import failures"
    - path: "GA-AppLocker/GUI/Panels/Policy.ps1"
      provides: "Toast notifications for policy creation/export failures"
    - path: "GA-AppLocker/GUI/Panels/Deploy.ps1"
      provides: "Toast notifications for deployment failures"
  key_links:
    - from: "Invoke-BatchRuleGeneration catch blocks"
      to: "@{ Success = $false; Error = ... }"
      via: "Structured return replaces raw $null"
      pattern: "Success\\s*=\\s*\\$false.*Error\\s*="
    - from: "GUI/Panels catch blocks (operator-visible)"
      to: "Show-Toast"
      via: "catch { Show-Toast -Message ... -Type Error }"
      pattern: "catch.*Show-Toast.*Error"
---

<objective>
Standardize return patterns for 3 key backend functions and add toast notifications for operator-visible errors in 6 GUI panels.

Purpose: ERR-04 — callers of Invoke-BatchRuleGeneration, Get-AppLockerEventLogs, and Remove-DuplicateRules currently get `$null` on failure and must use defensive null guards. Standardizing to `@{ Success; Data; Error }` lets callers use `.Success` consistently. ERR-05 — operators currently only learn about failures by reading log files. Surfacing errors as toast notifications provides immediate feedback.

Output: 3 backend functions with standardized returns, 6 panel files with toast notifications on key error paths.
</objective>

<execution_context>
@/home/anthonyscry/.claude/get-shit-done/workflows/execute-plan.md
@/home/anthonyscry/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Invoke-BatchRuleGeneration.ps1
@GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1
@GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Remove-DuplicateRules.ps1
@GA-AppLocker/GUI/Panels/Scanner.ps1
@GA-AppLocker/GUI/Panels/Rules.ps1
@GA-AppLocker/GUI/Panels/Policy.ps1
@GA-AppLocker/GUI/Panels/Deploy.ps1
@GA-AppLocker/GUI/Panels/Dashboard.ps1
@GA-AppLocker/GUI/Panels/Credentials.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Standardize return patterns in Invoke-BatchRuleGeneration, Get-AppLockerEventLogs, and Remove-DuplicateRules (ERR-04)</name>
  <files>
    GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Invoke-BatchRuleGeneration.ps1
    GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1
    GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Remove-DuplicateRules.ps1
  </files>
  <action>
For each of the 3 functions, replace `return $null` exit paths with `@{ Success = $false; Data = $null; Error = "<reason>" }`.

**Invoke-BatchRuleGeneration.ps1:**
- Find all `return $null` statements in the main function (not in private helpers like Get-FileNameFromArtifact or Convert-ArtifactToRule which are internal and return $null legitimately for skip/filter purposes)
- Replace with `return @{ Success = $false; Data = $null; Error = "<context of why it failed>" }`
- If the function has a success path that returns raw data (like an array of rules), wrap it: `return @{ Success = $true; Data = $rules; Error = $null }`
- IMPORTANT: Internal/private helper functions within the same file that return $null for skip/filter semantics should NOT be changed — only the main exported function's return paths

**Get-AppLockerEventLogs.ps1:**
- Find all `return $null` statements in the main exported function
- Replace with `return @{ Success = $false; Data = $null; Error = "<context>" }`
- Wrap successful returns: `return @{ Success = $true; Data = $events; Error = $null }`

**Remove-DuplicateRules.ps1:**
- Find all `return $null` or bare `return` in the main exported function
- Replace with `return @{ Success = $false; Data = $null; Error = "<context>" }`
- Wrap successful returns with data about what was removed: `return @{ Success = $true; Data = @{ RemovedCount = $removedCount; KeptCount = $keptCount }; Error = $null }`

After changing return patterns, check that callers in GUI/Panels handle the new return shape. Search for calls to these functions in Panel files. If a caller currently checks `$result -eq $null`, update it to check `$result.Success -eq $false`. If a caller already checks `.Success`, no change needed.

Do NOT change internal/private helper functions that return $null for skip/filter semantics.
Do NOT change the Validation module (locked area per CLAUDE.md constraints).
  </action>
  <verify>
Run: `grep -n 'return \$null' GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Invoke-BatchRuleGeneration.ps1 GA-AppLocker/Modules/GA-AppLocker.Scanning/Functions/Get-AppLockerEventLogs.ps1 GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Remove-DuplicateRules.ps1`
- Invoke-BatchRuleGeneration: $null returns should only remain in private helpers (Get-FileNameFromArtifact, Convert-ArtifactToRule), not in the main Invoke-BatchRuleGeneration function
- Get-AppLockerEventLogs: zero $null returns in main function
- Remove-DuplicateRules: zero $null returns in main function

Run: `grep -c 'Success.*=' GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Invoke-BatchRuleGeneration.ps1` — should show new Success returns
  </verify>
  <done>Invoke-BatchRuleGeneration, Get-AppLockerEventLogs, and Remove-DuplicateRules all return @{ Success; Data; Error } on every exit path. Callers updated to check .Success instead of null guards.</done>
</task>

<task type="auto">
  <name>Task 2: Add toast notifications for operator-visible errors in GUI panels (ERR-05)</name>
  <files>
    GA-AppLocker/GUI/Panels/Scanner.ps1
    GA-AppLocker/GUI/Panels/Rules.ps1
    GA-AppLocker/GUI/Panels/Policy.ps1
    GA-AppLocker/GUI/Panels/Deploy.ps1
    GA-AppLocker/GUI/Panels/Dashboard.ps1
    GA-AppLocker/GUI/Panels/Credentials.ps1
  </files>
  <action>
Add `Show-Toast -Message "..." -Type Error` calls to operator-visible error paths in each panel. These are catch blocks where the operator performed an explicit action (clicked a button, triggered a scan, saved a rule) and the operation failed.

Target error paths per panel:

**Scanner.ps1** — scan start failures, remote scan connection failures:
- In catch blocks around `Start-ArtifactScan` calls: `Show-Toast -Message "Scan failed: $_" -Type Error`
- In catch blocks around remote machine connection: `Show-Toast -Message "Remote scan failed: $_" -Type Error`

**Rules.ps1** — rule save failures, import failures, bulk operation failures:
- In catch blocks around `Import-RulesFromXml`: `Show-Toast -Message "Rule import failed: $_" -Type Error`
- In catch blocks around `New-PathRule`/`New-HashRule`/`New-PublisherRule` save operations: `Show-Toast -Message "Rule creation failed: $_" -Type Error`
- In catch blocks around bulk operations (Change Action, Change Group, Delete): `Show-Toast -Message "Bulk operation failed: $_" -Type Error`

**Policy.ps1** — policy creation, export failures:
- In catch blocks around `New-Policy`: `Show-Toast -Message "Policy creation failed: $_" -Type Error`
- In catch blocks around `Export-PolicyToXml`: `Show-Toast -Message "Policy export failed: $_" -Type Error`

**Deploy.ps1** — deployment start failures:
- In catch blocks around `Start-Deployment`: `Show-Toast -Message "Deployment failed: $_" -Type Error`

**Dashboard.ps1** — only add toast for "Initialize All" failures (the one user-triggered action):
- In catch block around `Initialize-AppLockerEnvironment`: `Show-Toast -Message "Initialization failed: $_" -Type Error`

**Credentials.ps1** — credential save/test failures:
- In catch blocks around `New-CredentialProfile` or `Test-CredentialProfile`: `Show-Toast -Message "Credential operation failed: $_" -Type Error`

IMPORTANT: Do NOT add toast notifications to:
- UI cosmetic catch blocks (FindName, brush, layout) — these are DEBUG-level, not operator-visible
- Data loading catch blocks that already have toast calls (check first!)
- Automatic background operations (auto-refresh, timer ticks) — these are not operator-initiated

The toast call should be ADDED alongside the existing Write-AppLockerLog call (from plans 01-03), not replacing it. Pattern:

```powershell
catch {
    Write-AppLockerLog -Message "[Panel] Failed to <operation>: $_" -Level ERROR
    Show-Toast -Message "Operation failed: $_" -Type Error
}
```
  </action>
  <verify>
Run: `grep -c 'Show-Toast.*Error' GA-AppLocker/GUI/Panels/Scanner.ps1 GA-AppLocker/GUI/Panels/Rules.ps1 GA-AppLocker/GUI/Panels/Policy.ps1 GA-AppLocker/GUI/Panels/Deploy.ps1 GA-AppLocker/GUI/Panels/Dashboard.ps1 GA-AppLocker/GUI/Panels/Credentials.ps1`
Each file should show increased error toast count compared to before.

Spot-check Scanner.ps1 to confirm toast is in the Start-ArtifactScan catch block.
Spot-check Rules.ps1 to confirm toast is in the Import-RulesFromXml catch block.
  </verify>
  <done>Operator-visible error paths in Scanner, Rules, Policy, Deploy, Dashboard, and Credentials panels surface failures via Show-Toast Error notifications. Operators see immediate feedback when scan, save, import, export, or deployment operations fail.</done>
</task>

</tasks>

<verification>
1. `grep -c 'Success.*=' GA-AppLocker/Modules/GA-AppLocker.Rules/Functions/Invoke-BatchRuleGeneration.ps1` shows new Success returns in main function
2. `grep -c 'Show-Toast.*Error' GA-AppLocker/GUI/Panels/Scanner.ps1` shows scan failure toasts
3. `grep -c 'Show-Toast.*Error' GA-AppLocker/GUI/Panels/Rules.ps1` shows rule operation failure toasts
4. Spot-check that callers of Invoke-BatchRuleGeneration check .Success instead of $null
</verification>

<success_criteria>
- Invoke-BatchRuleGeneration, Get-AppLockerEventLogs, Remove-DuplicateRules return @{ Success; Data; Error } on all exit paths (main function only, not internal helpers)
- Scanner, Rules, Policy, Deploy, Dashboard, Credentials panels show toast Error notifications on operator-triggered failures
- Toast messages are specific to the failed operation (not generic "Error occurred")
- Existing Write-AppLockerLog calls preserved alongside new toast calls
</success_criteria>

<output>
After completion, create `.planning/phases/10-error-handling-hardening/10-04-SUMMARY.md`
</output>
